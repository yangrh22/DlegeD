<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D了个D - 大学生DDL挑战</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a1a;
            color: #fff;
            margin: 0;
            min-height: 100vh;
        }
        #game-container {
            position: relative;
            max-width: 600px;
            width: 100%;
            height: 400px;
            background-color: #2e2e2e;
            border: 4px solid #fff;
            border-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAAEElEQVR4nGP4z8DAwMCAgQEA4gABNubJ+QAAAABJRU5ErkJggg==') 4;
            margin-top: 20px;
            overflow: hidden;
        }
        .tile {
            position: absolute;
            width: 32px;
            height: 32px;
            background-size: contain;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }
        .tile.top-layer {
            box-shadow: 0 0 3px #fff;
            opacity: 1;
        }
        .tile:not(.top-layer) {
            opacity: 0.65;
        }
        .tile.top-layer:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        #slot-container {
            position: relative;
            max-width: 600px;
            width: 100%;
            height: 80px;
            background-color: #4a4a4a;
            border: 4px solid #fff;
            border-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAAEElEQVR4nGP4z8DAwMCAgQEA4gABNubJ+QAAAABJRU5ErkJggg==') 4;
            margin-top: 10px;
            display: flex;
            align-items: center;
        }
        .slot {
            width: 80px;
            height: 64px;
            border: 2px dashed #555;
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: 32px;
            background-position: center;
            background-repeat: no-repeat;
        }
        #character {
            position: absolute;
            top: -32px;
            width: 32px;
            height: 32px;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjI0IiBoZWlnaHQ9IjMyIiB2aWV3Qm94PSIwIDAgMjI0IDMyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0iIzAwZiIvPjxwYXRoIGQ9Ik0xNiAxNiA0IDRoOCIgZmlsbD0iI2ZmZiIvPjxyZWN0IHg9IjMyIiB5PSIwIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiMwMGYiLz48cGF0aCBkPSJNMTYgMTYgNCAtNGg4IiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iNjQiIHk9IjAiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0iIzAwZiIvPjxwYXRoIGQ9Ik0xNiAxNiAtNCAtNGg4IiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iOTYiIHk9IjAiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0iIzAwZiIvPjxwYXRoIGQ9Ik0xNiAxNiAtNCAtNGg4IiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iMTI4IiB5PSIwIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiMwMGYiLz48cGF0aCBkPSJNMTYgMTYgNCAtNGg4IiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iMTYwIiB5PSIwIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiMwMGYiLz48cGF0aCBkPSJNMTYgMTYgNCAtNGg4IiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iMTkyIiB5PSIwIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiMwMGYiLz48cGF0aCBkPSJNMTYgMTYgNCAtNGg4IiBmaWxsPSIjZmZmIi8+PC9zdmc+');
            background-size: 224px 32px;
            transition: left 0.3s;
        }
        @keyframes walk {
            0% { background-position: 0 0; }
            25% { background-position: -32px 0; }
            50% { background-position: -64px 0; }
            75% { background-position: -96px 0; }
            100% { background-position: 0 0; }
        }
        #character.walking {
            animation: walk 0.6s steps(4) infinite;
        }
        #ddl-line {
            position: absolute;
            right: 10px;
            top: 0;
            width: 4px;
            height: 80px;
            background-color: #f44;
        }
        #message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #f44;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 4px solid #fff;
            border-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAAEElEQVR4nGP4z8DAwMCAgQEA4gABNubJ+QAAAABJRU5ErkJggg==') 4;
            display: none;
        }
        #restart {
            margin: 10px;
            padding: 8px 16px;
            font-size: 10px;
            background-color: #f44;
            color: #fff;
            border: 2px solid #fff;
            cursor: pointer;
        }
        #restart:hover {
            background-color: #f66;
        }
    </style>
</head>
<body>
    <h1>D了个D</h1>
    <div id="game-container"></div>
    <div id="slot-container">
        <div id="character" class="walking"></div>
        <div id="ddl-line"></div>
    </div>
    <div id="message"></div>
    <button id="restart">重新开始</button>

    <script>
        const tasks = [
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSI2IiB5PSI0IiB3aWR0aD0iMjAiIGhlaWdodD0iMjQiIGZpbGw9IiMzMzMiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+PHJlY3QgeD0iOCIgeT0iNiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE4IiBmaWxsPSIjMGFmIi8+PHBhdGggZD0iTTEwIDEwIDYgNmg4IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMSIvPjxjaXJjbGUgY3g9IjIwIiBjeT0iMjQiIHI9IjEiIGZpbGw9IiNmZmYiLz48L3N2Zz4=', action: 0 }, // 玩手机
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI4IiBjeT0iMTYiIHI9IjQiIGZpbGw9IiNmZjYiIHN0cm9rZT0iIzMzMyIvPjxjaXJjbGUgY3g9IjI0IiBjeT0iMTYiIHI9IjQiIGZpbGw9IiNmZjYiIHN0cm9rZT0iIzMzMyIvPjxwYXRoIGQ9Ik0xMiAxMiAyMCAyMCIgZmlsbD0iIzAwMCIvPjxjaXJjbGUgY3g9IjIyIiBjeT0iMTAiIHI9IjEiIGZpbGw9IiMwMGYiLz48L3N2Zz4=', action: -32 }, // 健身
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTEwIDEwIDIyIDIyIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMSIvPjxwYXRoIGQ9Ik0yMiAxMCAxMCAyMiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEiLz48Y2lyY2xlIGN4PSI4IiBjeT0iOCIgcj0iMSIgZmlsbD0iIzAwMCIvPjwvc3ZnPg==', action: -64 }, // 赶作业
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSI2IiB5PSI4IiB3aWR0aD0iMTQiIGhlaWdodD0iMTYiIGZpbGw9IiM0NDQiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+PHJlY3QgeD0iMTIiIHk9IjgiIHdpZHRoPSIxNCIgaGVpZ2h0PSIxNiIgZmlsbD0iIzQ0NCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNMTAgMTIgMjAgMTIiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxIi8+PGNpcmNsZSBjeD0iMTQiIGN5PSIxNiIgcj0iMSIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==', action: -96 }, // 写论文
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iMjAiIGhlaWdodD0iMTQiIGZpbGw9IiMzMzMiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTEwIDE4IDEwIDE0IDE0IDE0IDE0IDE4IDE4IDE4IDE4IDE0IiBmaWxsPSIjZmZmIi8+PC9zdmc+', action: -128 }, // 小组Pre
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSI4IiBmaWxsPSIjZmY2IiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIvPjxwYXRoIGQ9Ik0xMiAxMiAyMCAxMiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEiLz48cGF0aCBkPSJNMTIgMjAgMjAgMjAiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+PHBhdGggZD0iTTE2IDEwIDE2IDgiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9zdmc+', action: -160 }, // 吃饭
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSI2IiB5PSIxOCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjgiIGZpbGw9IiMwYWYiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTEwIDE0IDE2IDEwIDE0IDE0IiBmaWxsPSIjZmZmIi8+PHBhdGggZD0iTTE4IDEwIDIyIDE0IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg==', action: -192 } // 睡觉
        ];
        const slotCapacity = 5;
        let tiles = [];
        let slots = [];
        let character = null;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function initGame() {
            console.log('初始化游戏...');
            tiles = [];
            slots = [];
            const gameContainer = document.getElementById('game-container');
            const slotContainer = document.getElementById('slot-container');
            const message = document.getElementById('message');
            gameContainer.innerHTML = '';
            slotContainer.innerHTML = '<div id="character" class="walking"></div><div id="ddl-line"></div>';
            slotContainer.style.backgroundColor = '#4a4a4a';
            message.style.display = 'none';
            character = document.getElementById('character');

            // 生成30个图标（7种，约4-5个）
            const taskCounts = [5, 5, 4, 4, 4, 4, 4]; // 总计30
            tasks.forEach((task, idx) => {
                for (let i = 0; i < taskCounts[idx]; i++) {
                    const x = 20 + Math.random() * (560 - 40);
                    const y = 20 + Math.random() * (300 - 40);
                    const z = Math.floor(Math.random() * 3);
                    tiles.push({ task, x, y, z, element: null });
                }
            });
            shuffle(tiles);
            console.log('生成图标：', tiles.length);

            // 渲染图标，标记顶层
            const maxZ = Math.max(...tiles.map(t => t.z));
            tiles.forEach((tile, index) => {
                const div = document.createElement('div');
                div.className = 'tile' + (tile.z === maxZ ? ' top-layer' : '');
                div.style.left = `${tile.x}px`;
                div.style.top = `${tile.y}px`;
                div.style.zIndex = tile.z;
                div.style.backgroundImage = `url(${tile.task.icon})`;
                div.dataset.index = index;
                div.addEventListener('click', handleTileClick);
                div.addEventListener('touchstart', handleTileClick);
                gameContainer.appendChild(div);
                tile.element = div;
            });

            // 初始化DDL槽
            for (let i = 0; i < slotCapacity; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slotContainer.appendChild(slot);
            }
        }

        function handleTileClick(e) {
            e.preventDefault();
            const index = parseInt(e.target.dataset.index);
            const tile = tiles[index];
            if (!tile || !tile.element) return;

            const rect = tile.element.getBoundingClientRect();
            const isBlocked = tiles.some(other => {
                if (other && other !== tile && other.element && parseInt(other.element.style.zIndex) > tile.z) {
                    const otherRect = other.element.getBoundingClientRect();
                    return (
                        rect.left < otherRect.right &&
                        rect.right > otherRect.left &&
                        rect.top < otherRect.bottom &&
                        rect.bottom > otherRect.top
                    );
                }
                return false;
            });

            console.log(`点击图标: z=${tile.z}, 阻挡=${isBlocked}`);
            if (!isBlocked && slots.length < slotCapacity) {
                slots.push(tile.task);
                tile.element.remove();
                tiles[index] = null;
                updateSlots();
                checkMatches();
                checkGameState();
            }
        }

        function updateSlots() {
            const slotElements = document.querySelectorAll('.slot');
            slotElements.forEach((slot, i) => {
                slot.style.backgroundImage = slots[i] ? `url(${slots[i].icon})` : '';
            });

            const slotCount = slots.length;
            if (slotCount > 0) {
                character.style.left = `${80 * slotCount + 40}px`;
                character.style.backgroundPosition = `${slots[slotCount - 1].action}${slotCount >= 2 ? ' -32' : ' 0'}px 0`;
            } else {
                character.style.left = '40px';
                character.style.backgroundPosition = '0 0';
            }

            slotContainer.style.backgroundColor = slotCount <= 1 ? '#4a4a4a' : slotCount <= 3 ? '#f99' : '#f33';
        }

        function checkMatches() {
            const counts = {};
            slots.forEach(slot => {
                counts[slot.icon] = (counts[slot.icon] || 0) + 1;
            });

            for (let icon in counts) {
                if (counts[icon] >= 3) {
                    slots = slots.filter(slot => slot.icon !== icon);
                    updateSlots();
                }
            }
        }

        function checkGameState() {
            const message = document.getElementById('message');
            if (slots.length >= slotCapacity) {
                message.innerHTML = 'DDL已过！';
                message.style.display = 'block';
                character.classList.remove('walking');
            } else if (tiles.every(t => !t)) {
                message.innerHTML = '恭喜赶上DDL！';
                message.style.display = 'block';
                character.classList.remove('walking');
            }
        }

        document.getElementById('restart').addEventListener('click', initGame);

        setTimeout(() => {
            initGame();
            console.log('游戏已加载');
        }, 100);
    </script>
</body>
</html>
