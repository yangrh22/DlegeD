<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D了个D - 大学生DDL挑战</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a1a;
            color: #fff;
            margin: 0;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 600px;
            height: 400px;
            background-color: #2e2e2e;
            border: 4px solid #fff;
            border-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAAEElEQVR4nGP4z8DAwMCAgQEA4gABNubJ+QAAAABJRU5ErkJggg==') 4;
            margin-top: 20px;
        }
        .tile {
            position: absolute;
            width: 32px;
            height: 32px;
            background-size: contain;
            border: 1px solid #fff; /* 调试边框 */
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }
        .tile:hover {
            transform: scale(1.2);
            filter: brightness(1.2);
        }
        #slot-container {
            position: relative;
            width: 600px;
            height: 80px;
            background-color: #4a4a4a;
            border: 4px solid #fff;
            border-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAAEElEQVR4nGP4z8DAwMCAgQEA4gABNubJ+QAAAABJRU5ErkJggg==') 4;
            margin-top: 10px;
            display: flex;
            align-items: center;
        }
        .slot {
            width: 80px;
            height: 64px;
            border: 2px dashed #555;
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: 32px;
            background-position: center;
            background-repeat: no-repeat;
        }
        #character {
            position: absolute;
            top: -32px;
            width: 16px;
            height: 16px;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAgCAYAAABlWv4PAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADbSURBVGhD7ZkxCsMwDEQ//6X/f3Q3kRFt3YgQov2g0mVZ9j+EEABJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiRJkiQJ/wF82z/0gAAAABJRU5ErkJggg==');
            background-size: 80px 16px;
            transition: left 0.3s;
        }
        @keyframes walk {
            0% { background-position: 0 0; }
            50% { background-position: -16px 0; }
            100% { background-position: -32px 0; }
        }
        #character.walking {
            animation: walk 0.6s steps(3) infinite;
        }
        #ddl-line {
            position: absolute;
            right: 10px;
            top: 0;
            width: 4px;
            height: 80px;
            background-color: #ff4040;
        }
        #message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff4040;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border: 4px solid #fff;
            border-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAAEElEQVR4nGP4z8DAwMCAgQEA4gABNubJ+QAAAABJRU5ErkJggg==') 4;
            display: none;
        }
        #restart {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 12px;
            background-color: #ff4040;
            color: #fff;
            border: 2px solid #fff;
            cursor: pointer;
        }
        #restart:hover {
            background-color: #ff6666;
        }
    </style>
</head>
<body>
    <h1>D了个D</h1>
    <div id="game-container"></div>
    <div id="slot-container"></div>
    <div id="message"></div>
    <button id="restart">重新开始</button>

    <script>
        // 任务图标（像素风 SVG base64）
        const tasks = [
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIyIiB5PSIyIiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIGZpbGw9IiM0NDQiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxIi8+PHJlY3QgeD0iNSIgeT0iNSIgd2lkdGg9IjYiIGhlaWdodD0iNSIgZmlsbD0iIzAwZiIvPjwvc3ZnPg==', action: 0 }, // 玩手机
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI0IiBjeT0iOCIgcj0iMiIgZmlsbD0iI2ZmNCIgc3Ryb2tlPSIjMDAwIi8+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSIyIiBmaWxsPSIjZmY0IiBzdHJva2U9IiMwMDAiLz48cmVjdCB4PSI2IiB5PSI3IiB3aWR0aD0iNCIgaGVpZ2h0PSIyIiBmaWxsPSIjNDQ0NDQiLz48L3N2Zz4=', action: -16 }, // 健身
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIyIiB5PSIyIiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+PHBhdGggZD0iTTMgM2w5IDkiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9zdmc+', action: -32 }, // 赶作业
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIyIiB5PSIyIiB3aWR0aD0iNiIgaGVpZ2h0PSIxMiIgZmlsbD0iIzQ0NCIgc3Ryb2tlPSIjZmZmIi8+PHJlY3QgeD0iOCIgeT0iMiIgd2lkdGg9IjYiIGhlaWdodD0iMTIiIGZpbGw9IiM4ODgiIHN0cm9rZT0iI2ZmZiIvPjwvc3ZnPg==', action: -48 }, // 写论文
            { icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIyIiB5PSIyIiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIGZpbGw9IiMwMDAiIHN0cm9rZT0iI2ZmZiIvPjxwYXRoIGQ9Ik00IDR2N2gyVi02aDJWNmgyViIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjEiLz48L3N2Zz4=', action: -64 } // 小组Pre
        ];
        const slotCapacity = 5;
        let tiles = [];
        let slots = [];
        let character = null;
        let slotContainer = null;
        let message = null;

        // 洗牌算法
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 初始化游戏
        function initGame() {
            tiles = [];
            slots = [];
            const gameContainer = document.getElementById('game-container');
            slotContainer = document.getElementById('slot-container');
            message = document.getElementById('message');
            gameContainer.innerHTML = '';
            slotContainer.innerHTML = '<div id="character" class="walking"></div><div id="ddl-line"></div>';
            slotContainer.style.backgroundColor = '#4a4a4a';
            message.style.display = 'none';

            // 生成30个图标，每种6个
            tasks.forEach(task => {
                for (let i = 0; i < 6; i++) {
                    const x = 50 + Math.random() * (600 - 100);
                    const y = 50 + Math.random() * (400 - 100);
                    const z = Math.floor(Math.random() * 3) + 1; // 层级 1-3
                    tiles.push({ task, x, y, z, element: null });
                }
            });
            tiles = shuffle(tiles); // 打乱

            // 渲染图标
            tiles.forEach((tile, index) => {
                const div = document.createElement('div');
                div.className = 'tile';
                div.style.left = `${tile.x}px`;
                div.style.top = `${tile.y}px`;
                div.style.zIndex = tile.z;
                div.style.backgroundImage = `url(${tile.task.icon})`;
                div.dataset.index = index;
                div.addEventListener('click', handleTileClick);
                gameContainer.appendChild(div);
                tile.element = div;
            });

            // 初始化DDL槽
            for (let i = 0; i < slotCapacity; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slotContainer.appendChild(slot);
            }
            character = document.getElementById('character');
        }

        // 处理图标点击
        function handleTileClick(e) {
            const index = parseInt(e.target.dataset.index);
            const tile = tiles[index];
            if (!tile || !tile.element) return;

            // 精确遮挡检测
            const rect = tile.element.getBoundingClientRect();
            const isBlocked = tiles.some(other => {
                if (other && other.element && other !== tile && other.z > tile.z) {
                    const otherRect = other.element.getBoundingClientRect();
                    return (
                        rect.left < otherRect.right &&
                        rect.right > otherRect.left &&
                        rect.top < otherRect.bottom &&
                        rect.bottom > otherRect.top
                    );
                }
                return false;
            });

            if (!isBlocked && slots.length < slotCapacity) {
                slots.push(tile.task);
                tile.element.remove();
                tiles[index] = null;
                updateSlots();
                checkMatches();
                checkGameState();
            }
        }

        // 更新DDL槽
        function updateSlots() {
            const slotElements = document.querySelectorAll('.slot');
            slotElements.forEach((slot, i) => {
                slot.style.backgroundImage = slots[i] ? `url(${slots[i].icon})` : '';
            });

            // 更新小人
            const slotCount = slots.length;
            if (slotCount > 0) {
                character.style.left = `${80 * (slotCount - 1) + 40}px`;
                character.style.backgroundPosition = `${slots[slotCount - 1].action}px 0`;
            } else {
                character.style.left = '0px';
                character.style.backgroundPosition = '0px 0';
            }

            // 更新槽颜色和表情
            if (slotCount <= 1) {
                slotContainer.style.backgroundColor = '#4a4a4a';
            } else if (slotCount <= 3) {
                slotContainer.style.backgroundColor = '#ff9999';
                character.style.backgroundPosition = `${slots[slotCount - 1].action - 16}px 0`; // 紧张
            } else {
                slotContainer.style.backgroundColor = slotCount === slotCapacity ? '#ff3333' : '#ff6666';
                character.style.backgroundPosition = `${slots[slotCount - 1].action - 32}px 0`; // 恐慌
            }
        }

        // 检查三消
        function checkMatches() {
            const counts = {};
            slots.forEach(slot => {
                counts[slot.icon] = (counts[slot.icon] || 0) + 1;
            });

            for (let icon in counts) {
                if (counts[icon] >= 3) {
                    slots = slots.filter(slot => slot.icon !== icon);
                    updateSlots();
                }
            }
        }

        // 检查游戏状态
        function checkGameState() {
            if (slots.length >= slotCapacity) {
                message.innerHTML = 'DDL 已过！';
                message.style.display = 'block';
                character.classList.remove('walking');
            } else if (tiles.every(t => !t)) {
                message.innerHTML = '恭喜你赶上DDL！';
                message.style.display = 'block';
                character.classList.remove('walking');
            }
        }

        // 重启游戏
        document.getElementById('restart').addEventListener('click', initGame);

        // 延迟初始化
        window.onload = initGame;
    </script>
</body>
</html>
